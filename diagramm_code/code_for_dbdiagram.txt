// Типы сущностей
Table object_types as OT {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    type text [not null, unique]
}

// Группы статусов
Table status_groups as ST {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    status_group text [not null, unique]
}

// Статусы
Table statuses as SS {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    status_group_id int [not null, ref: > ST.id]
    status text [not null, unique]
}

// Пользователи
Table users as U {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    last_name text
    first_name text [not null]
    middle_name text
    birth_date date
    email text [unique, not null]
    password_hash text [not null]
    phone text
    gender int [not null, default: 1]
    status_id int [not null, ref: > SS.id]
}

// Адреса
Table adresses as AD {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    object_type int [not null, ref: > OT.id]
    object_id int [not null]
    address_object jsonb
    address_full_str text
    postal_code text
    country text
    region text
    settlement_type text
    settlement text
    street text
    house text
    block_val text
    flat text
}

// Категории товаров
Table categories as CT {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    parent_id int [not null, ref: > CT.id]
    category text [not null, unique]
}

// Производители товаров
Table manufacturers as M {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    manufacturer text [not null]
    logo_link text [not null]
    site_link text
}

// Поставщики
Table suppliers as S {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    supplier text [not null, unique]
    company_phone text
    manager_id int [ref: > U.id]
    site_link text
}

// Единицы измерения (грамм, шт., упаковка и т.п)
Table units as UN {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    unit text [not null, unique]
}

// Товары (справочник)
Table products as P {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    vendor_code text [not null]
    product text [not null]
    manufacturer_id int [not null, ref: > M.id]
    supplier_id int [not null, ref: > S.id]
    category_id int [ref: > CT.id]
    photos text[]
    description_text text
    status_id int [not null, ref: > SS.id]
}

// Справочник характеристик товара
Table parameters as PR {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    parameter text [not null, unique]
}

// Связь характеристик товара с продуктом  
Table product_params {
    dttmcr timestamptz [not null, default: `now()`]
    product_id int [not null, ref: > P.id]
    parameter_id int [not null, unique, ref: > PR.id]
    value_int int
    value_text text
    value_numeric numeric
    value_int_arr int[]
    value_text_arr text[]
    value_jsonb jsonb
}

// Цены
Table prices as PC {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    product_id int [not null, ref: > P.id]
    unit_id int [not null, ref: > UN.id]
    unit_amount int [not null, default: 1]
    mass numeric 
    price numeric [not null]
}

// Прайс-листы
Table pricelists as PL {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    actuality_date date [not null]
    manager_id int [not null, ref: > U.id]
}

// Прайлистс_товары
Table pricelist_products as PP {
    dttmcr timestamptz [not null, default: `now()`]
    pricelist_id int [not null, ref: > PL.id]
    product_id int [not null, ref: > P.id]
    price_id int [not null, ref: > PC.id]
}

// Справочник характеристик товара
Table pay_methods as PM {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    pay_method text [not null, unique]
}

// Справочник способов доставки
Table ship_methods as SM {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    ship_method text [not null, unique]
}

// Заказы
Table orders as O {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    user_id int [not null, ref: > U.id]
    order_sum numeric [not null]
    pay_method_id int [not null, ref: > PM.id]
    ship_method_id int [not null, ref: > SM.id]
    address_id int [not null, ref: > AD.id]
    last_status_id int [not null, ref: > SS.id]
}

// Товары в заказе
Table order_items {
    dttmcr timestamptz [not null, default: `now()`]
    order_id int [not null, ref: > O.id]
    product_id int [not null, ref: > P.id]
    price_id int [not null, ref: > PC.id]
    amount int [not null, default: 1]
} 

// История смены статусов
// поле object_id не является ссылкой на какую-либо таблицу
Table statuses_history as SY {
    id bigint [pk, increment, not null, unique]    
    dttmcr timestamptz [not null, default: `now()`]
    dttmend timestamptz
    object_type int [not null, ref: > OT.id]
    object_id int [not null]
    status_id int [not null, ref: > SS.id]
}

// Доставка
Table shipping as SH {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    order_id bigint [not null, ref: > O.id]
    ship_method_id int [not null, ref: > SM.id]
    ship_date date 
    ship_price numeric [default: 0]
    status_id int [not null, ref: > SS.id]
}

// Поставки
Table deliveries as D {
    id int [pk, increment, not null, unique]
    dttmcr timestamptz [not null, default: `now()`]
    operation int [not null]
    supplier_id int [not null, ref: > S.id]
}

// Поставка-товары
Table delivery_items as DI {
    dttmcr timestamptz [not null, default: `now()`]
    delivery_id int [not null, ref: > D.id]
    product_id int [not null, ref: > P.id]
    price_id int [not null, ref: > PC.id]
    amount int [not null, default: 1]
}
