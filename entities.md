# Сущности БД

## Общие справочники

1. **Группы статусов** (status_groups)

    Справочник названий категорий, под которые заводятся отдельные для каждой категории наборы статусов (таблица статусов). Примеры групп: Пользователи, Товары, Заказы.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *status_group* - название группы

    Данные таблицы используются для классификации и удобства.

1. **Статусы** (statuses)

    Справочник статусов. Каждый статус имеет ссылку на свою группу. Пример: для заказов могут быть такие статусы, как "Новый", "Оплачен", "Доставлен", "Отменён".

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *status_group_id* - идентификатор группы статусов
    * _status_name_ - статус

    Данные справочника могут использоваться в разных таблицах: Пользователи, Заказы, Товары и т.д.

1. **Пользователи** (users)
    
    Хранит данные о пользователях (физлицах): покупателях, представителях поставщиков, сотрудниках и т.п. Адреса доставки хранятся в таблице adresses. У пользователя может быть несколько адресов.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *last_name* - фамилия пользователя
    * *first_name* - имя пользователя
    * *middle_name* - отчество пользователя
    * *birth_date* - дата рождения 
    * _email_ - email 
    * *password_hash* - хэш пароля md5
    * _phone_ - телефон
    * _gender_ - пол (м,ж)
    * *status_id* - статус (активный, заблокирован, не подтверждён и т.п.)

    Данные используются таблицами orders, suppliers, statuses_history.

1. **Типы сущностей** (object_types)

    Справочник типов сущностей для хранения адресов и истории смены статусов. Нужен, чтобы различать идентификаторы записей в различных таблицах.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * _type_ - название типа 

1. **Адреса** (adresses)

    Хранит адреса в jsonb и развёрнутые по полям адреса для лучшего поиска для пользователей, производителей и поставщиков. Исходно адреса находятся в формате Dadata. Эта система позволяет при необходимости заводить несколько адресов для одной сущности. Обозначения типов: 1 - пользователи, 2 - производители, 3 - поставщики. Разворачивание данных из json происходит с помощью триггера.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *object_type* - идентификатор типа объекта, на который ссылается запись (свой код для пользователей, поставщиков и прозводителей)
    * *object_id* - идентификатор сущности (записи) в таблицах польз-лей, производителей и поставщиков
    * *address_object* - адрес, возвращаемый в формате json Dadata
    * *address_full_str* - адрес полной строкой
    * *postal_code* - почтовый индекс
    * _country_ - страна
    * _region_ - регион
    * *settlement_type* - тип населённого пункта
    * _settlement_ - населённый пункт
    * _street_ - улица
    * _house_ - дом
    * _block_val_ - строение
    * _flat_ - квартира

## Товары (склад)

1. **Производители** (manufacturers)

    Содержатся данные о производителях кофе и аксессуаров. По сути, это список брендов.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * _manufacturer_ - название производителя
    * *logo_link* - ссылка на логотип
    * *site_link* - ссылка на сайт

    Данные справочника используются в таблице products.

1. **Поставщики** (suppliers)

    Хранит данные о поставщиках товаров от производителей.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * _supplier_ - название компании поставщика
    * *company_phone* - общий телефон компании 
    * *manager_id* - идентификатор закреплённого менеджера
    * *site_link* text - ссылка на сайт компании

    Данные используются в таблице product_params.

1. **Категории товаров** (categories)

    Список категорий и подкатегорий товаров в виде дерева: каждая категория имеет ссылку на своего "родителя". Благодаря этому можно создавать сложную структуру категорий. У товара может быть только одна категория.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *parent_id* - ссылка на родительскую категорию (id категории из этой же таблицы)
    * _category_ - название категории

    Данные справочника используются сущностями самой таблицы, а также в таблице products.

1. **Единицы измеренения** товаров (units)

    Справочник списка единиц измерений товаров: упаковка, штука, граммы и т.п.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * _unit_ - название единицы измерения

    Данные справочника используются в таблице prices.

1. **Товары** (products)

    Справочник всех товаров интернет-магазина.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *vendor_code* - код производителя, артикул
    * _product_ - название товара
    * *manufacturer_id* - идентификатор производителя
    * *supplier_id* - идентификатор поставщика
    * *category_id* - идентификатор категории
    * _photos_ - массив ссылок на фотографии товара
    * _description_text_ - описание товара
    * *status_id* - идентификатор статуса

    Данные используются в таблицах order_items, order_history, prices.

1. **Характеристики товаров** (parameters)

    Справочник характеристик товаров. У каждого товара может быть 0 или больше характеристик.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * _parameter_ - название параметра

    Данные справочника используются в таблице product_params.

1. **"Товар_характеристика"** (product_params)

    Определяет связь продукта и характеристики. Для каждой характеристики указываются значения: одно или массив.

    * _dttmcr_ - дата и время создания записи
    * *product_id* - идентификатор продукта
    * *parameter_id* - идентификатор параметра
    * *value_int* - значение типа целое число
    * *value_text* - значение типа текст
    * *value_numeric* - дробное значение
    * *value_int_arr* - массив целых чисел
    * *value_text_arr* - массив значений типа текст
    * *value_jsonb* - значение типа jsonb

## Цены

1. **Способ оплаты** (pay_methods)

    Справочник способов оплаты товаров.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *pay_method* - название способа оплаты 

    Данные справочника используются в таблице orders.

1. **Цены** (prices)

    Справочник цен. Содержит стоимость продуктов для различных фасовок товара.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *product_id* - идентификатор продукта
    * *unit_id* - идентификатор упаковки
    * *unit_amount* - количество единиц товара
    * _mass_ - вес фасовки товара
    * _price_ - стоимость этой фасовки товара

1. **Прайслисты** (pricelists)

    Список формируемых на определённые даты актуальности прайс-листов.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *actuality_date* - дата актуальности прайс-листа
    * *manager_id* - идентификатор менеджера, сформировавшего прайс-лист

1. **Прайс-лист_товары** (pricelist_products)

    Связь товаров с ценами для определённого прайс-листа.

    * _dttmcr_ - дата и время создания записи
    * *pricelist_id* - идентификатор прайс-листа
    * *product_id* - идентифкатор продукта
    * *price_id* - идентификатор цены продукта

## Поставки товаров

1. **Поставки** (deliveries)

    Содержит данные о поставках товаров от поставщиков. Отсюда можно получить данные о наличии товаров на складе. На идентификатор поставки ссылаются данные из таблицы delivery_items.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * _operation_ - тип операции (1 - приход, 0 - возврат)
    * *supplier_id* - идентификатор поставщика

1. **Товары в поставке** (delivery_items)

    Таблица содержит данные о доставленных товарах (идентификатор и количество) в конкретной поставке. Стоимость единицы определяется конкретным прайсом.

    * _dttmcr_ - дата и время создания записи
    * *delivery_id* - идентификатор поставки
    * *product_id* - идентификатор продукта
    * *price_id* - идентификатор прайса
    * *amount* - количество единиц товара

## Заказы и доставка

1. **Способ доставки** (ship_methods)

    Справочник способов доставки товаров.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *ship_method* - название способа доставки

    Данные справочника используются в таблице orders.

1. **Заказы** (orders)

    Содержит заказы пользователей с суммой заказа, способом оплаты, доставки и последним статусом заказа (денормализация для удобства).

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *user_id* - идентификатор пользователя
    * *order_sum* - общая сумма заказа
    * *pay_method_id* - идентификатор способа оплаты
    * *ship_method_id* - идентификатор способа доставки
    * *address_id* - идентификатор адреса доставки
    * *last_status_id* - идентификатор статуса заказа

    Данные используются в таблице order_items.

1. **Товары в заказе** (order_items)

    Хранит список товаров и их кол-в в заказе пользователя.

    * _dttmcr_ - дата и время создания записи
    * *order_id* - идентификатор заказа
    * *product_id* - идентификатор продукта
    * *price_id* - идентификатор прайса
    * _amount_ - количество позиций товара

1. **Доставка** (shipping)

    Содержатся данные по доставке для заказов. Предполагаем, что адрес, куда доставить, находится у пользователя в профиле.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи
    * *order_id* - идентификатор заказа
    * *ship_method_id* - способ доставки
    * *ship_date* - предполагаемая дата доставки
    * *ship_price* - стоимость доставки
    * _status_id_ - статус доставки

## Процессы

1. **История смены статусов** (statuses_history)

    Хранит историю смены статусов сущностей (пользователей, заказов) во времени. Данные используются для построения отчётов.

    * _id_ - идентификатор записи
    * _dttmcr_ - дата и время создания записи (дата присвоения статуса)
    * _dttmend_ - дата смены присвоенного статуса (дата окончания действия статуса)
    * *object_type* - идентификатор типа сущности (пользователь, заказ, поставщик) 
    * *object_id* - идентификатор конкретной записи в таблицах сущностей
    * *status_id* - идентификатор присвоенного статуса
