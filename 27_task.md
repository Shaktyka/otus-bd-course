# Индексы в MySQL

Пересматриваем индексы на своем проекте. По необходимости меняем.
Задача - сделать полнотекстовый индекс, который ищет по свойствам, названию товара и описанию. 
Если нет аналогичной задачи в проекте - имитируем.
Итог: анализируем свой проект - добавляем или обновляем индексы.
В README пропишите, какие индексы были изменены или добавлены.
Explain и результаты выборки без индекса и с индексом.
Реализация полнотекстового индекса.

## Описание проекта

[Описание и схема проекта](22_task_new.md)

## Добавление индексов

При создании таблиц с ограничениями выяснилось, что MySQL автоматически создаёт индексы типа BTREE на поля:
1. id, т.к. это PRIMARY KEY
1. поля с ограничением UNIQUE
1. поля с ограничением FOREIGN KEY

1. **Таблица пользователей** - users

    Есть уникальный индекс на поле email и обычный индекс на поле referrer_fk.
    Добавлю составной индекс на поля email и password_hash, чтобы использовался при проверке аутентификации:

    `CREATE INDEX idx_users_auth ON users(email, password_hash);`

1. **Темы** - themes

    Есть уникальный индекс на поле theme.
    Другие индексы здесь не нужны.

1. **Категории тестов** - categories

    Есть уникальный индекс на поле theme_fk.
    Реализуем полнотекстовый поиск по названию категории и описанию.
    Для этого добавляю больше данных в таблицу (итого 9 строк).

    Запрос EXPLAIN до добавления индекса:
    ```
    EXPLAIN SELECT * FROM categories
    WHERE description LIKE '%геометри%';
    ```

    Результат EXPLAYN, видно, что в ходе запроса были перебраны все 9 строк:
    `'1','SIMPLE','categories',NULL,'ALL',NULL,NULL,NULL,NULL,'9','11.11','Using where'`

    Теперь добавим полнотекстовый поиск на столбцы category и description:
    ```
    CREATE FULLTEXT INDEX idx_fulltext_cat_desc 
    ON categories(category, description);
    ```

    Индекс добавлен:
    `'categories','1','idx_fulltext_cat_desc','2','description',NULL,'9',NULL,NULL,'YES','FULLTEXT','','','YES',NULL`

    Проанализируем таблицу:
    `ANALYZE TABLE categories;`

    Проанализируем запрос после добавления индекса:
    ```
    EXPLAIN SELECT * FRO categories
    WHERE MATCH (category, description) 
    AGAINST ('геометрия' IN NATURAL LANGUAGE MODE);
    ```

    Результат EXPLAYN, использован индекс, выбрана 1 строка:
    `'1','SIMPLE','categories',NULL,'fulltext','idx_fulltext_cat_desc','idx_fulltext_cat_desc','0','const','1','100.00','Using where; Ft_hints: sorted'`

1. **Тесты** - tests

    Есть уникальные индексы на полях user_fk и category_fk.
    Можно добавить полнотекстовый поиск на поля название и описание (name, description), будет по аналогии с таблицей categories.

    `CREATE FULLTEXT INDEX idx_ft_name_desc ON tests(name, description);`

    Сейчас в таблице следующие данные: [скриншот](/images/tests_table.jpg)

    Также можно добавить индексы на поля status (тип enum) и is_public (тип boolean).
    По статусам тестов будут выборки, чтобы выбирать тесты с определёнными статусами (на модерации, опубликован и др.).
    Флаг is_public показывает публичный тест или нет. Предполагаю, что публичных тестов будет гораздо меньше, чем приватных.

    Выборка данных без использования индекса:

    ```
    EXPLAIN SELECT * FROM tests 
    WHERE 
        status = 'on_moderation'
        AND is_public = 0;
    ```

    Результат EXPLAIN: перебор всех 14 строк
    `'1','SIMPLE','tests',NULL,'ALL',NULL,NULL,NULL,NULL,'14','7.14','Using where'`

    Деаем составной индекс на оба поля: status, is_public:
    `CREATE INDEX idx_status_is_public ON tests(status, is_public);` 

    Результат EXPLAIN после добавления индекса: использован индекс, выбрано 3 строки
    `'1','SIMPLE','tests',NULL,'ref','idx_tests_status','idx_tests_status','1','const','3','10.00','Using index condition; Using where'`

1. **Типы вопросов** - question_types

    В настоящий момент типов вопросов всего три и использоваться они будут на клиенте. Поэтому дополнительные индексы тут не требуются.

1. **Вопросы теста** - questions

    Есть автоматически созданные индексы на полях test_fk (идентификатор теста, к которому относится вопрос) и question_type_fk (идентификатор типа вопроса).

    Имеет смысл добавить индекс на поле тип вопроса (question_type), т.к. по типам игр наверняка будет сниматься статистика для отслеживания прохождения.

    `CREATE INDEX idx_question_type ON questions(question_type_fk);`

1. **Прохождение тестов (запуски)** - games

    Есть автоматически созданные индексы на полях user_fk (идентификатор пользователя, запускавшего тест) и test_fk (идентификатор теста, к которому относится вопрос). Все запросы поиска будут по этим двум полям.

1. **Прохождение тестов (ответы)** - game_answers

    Есть автоматически созданные индексы на полях game_fk (идентификатор игры) и question_fk (идентификатор вопроса). В дополнительных индексах пока не вижу необходимости.
