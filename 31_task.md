# Спрогнозировать рост данных и спроектировать модель хранения и архивации

Формируем документ в котором описываем

1. прогноз по возможному росту базы
1. рост данных
1. рост количества пользователей
1. всплески одновременных соединений
1. описываем возможные угрозы и методы защиты от них
1. предлагаем стратегии бэкапа, репликации, кластеризации

---

## О проекте

QuizGame - сервис корпоративной аттестации сотрудников компании. Предоставляется как дополнительный сервис, подключаемый к установленной CRM-системе. Организации приобретают подписку на CRM-систему и при необходимости могут приобрести данный сервис для регулярной аттестации своих работников. CRM рассчитана на средний и крупный бизнес. Работа с сервисом происходит в браузере.

Менеджеры подразделений создают в сервисе команды из сотрудников и заводят списки грейдов и ролей, аттестацию на которые они предполагают осуществлять. По каждому направлению с помощью конструктора создаются тесты с вопросами различных типов. К каждому грейду и уровню прикрепляются наборы тестов.

Для аттестации сотрудников менеджеры создают "сессии": назначают период, за который сотрудник должен пройти набор тестов. Сотрудник прошёл - квалификация считается выполненной, соответственно, сотрудник может получить повышение или какие-либо бонусы.

Сервис является "асинхронным" в плане того, что менеджерам не нужно отслеживать в каждый конкретный момент отдельные шаги сотрудников или их статус, им нужно знать, прошёл человек квалификацию в принципе или нет. 
Важно, чтобы данные сохранялись. Можно допустить не очень высокую доступность.

## Прогноз по возможному росту базы

Для проекта используем базу данных **PostgreSQL**: российское ПО, активно развивается, хорошая работа с JSONB, которого у нас в проекте много (варианты ответов и правильные ответы, ответы пользователей на тесты), разработчики имеют экспертизу в работе с этой БД.

Рост базы будет зависеть от способа установки CRM: либо компания ставит CRM и сервис аттестации на свой сервер,либо хостится у нас. Далее буду рассматривать случаи, когда компании хранят данные на наших серверах.

Очевидно, что рост базы будет происходить скачкообразно после подключения сервиса, когда менеджеры начнут заводить тесты для аттестации, создавать сессии для сотрудников, и особенно активно в периоды аттестаций, когда сотрудники начнут решать тесты.

Допустим, у нас популярная CRM и классный сервис, и мы подключаем к сервису 2 клиентов каждую неделю.
Итого в месяц у нас может быть 2 организации крупного бизнеса и 5 организаций среднего.
В год получается 24 крупных клиентов и 60 средних.

## Рост данных

Поскольку сервис является корпоративным, не предполагается больших объёмов и интенсивной записи данных в принципе, как, например, в сервисе такси, где водителям нужно передавать данные каждые несколько секунд. Количество тестов в базе - это достаточно стабильное число. Основной массив тестов заведут примерно в начале работы с сервисом, а потом контент уже не будет часто меняться. Основная запись данных будет происходить в таблицу запусков тестов и особенно в таблицу фиксации ответов на вопросы тестов во время сессий. Поэтому эти таблицы можно сделать партицированными по годам.

Таблицы с этими данными у клиентов не превысят нескольких гигабайт даже за несколько лет.

Допустим следующие предположения по данным:

1. Данные в базе будут в основном текстовыми. Сервис предполагает загрузку изображений, но для взрослых людей основной источник информации - это всё-таки текст.
1. Для каждого грейда (например, "SQL-девелопер Junior") нужно успешно пройти в среднем 12 тестов.
1. В каждом тесте в среднем по 15 вопросов. Это 180 вопросов по всем тестам.
1. В каждом вопросе в среднем 4 варианта ответов. Это 720 записей.
В принципе, данных на одну квалификацию немного.

## Рост количества пользователей

Поскольку сервис является корпоративным, не предполагается крутой рост количества пользователей.
Количество пользователей будет увеличиваться 1) в периоды подключений сервиса, когда будут активно создаваться тесты, 2) в периоды аттестаций, когда большое количество сотрудников компаний в течение нескольких дней будет часто заходить на сайт. Обычно аттестации проходят в определённые периоды года или же регулярно с интервалами в 3 - 6 месяцев, и в эти периоды стоит ожидать значительное повышение нагрузки.

## Всплески одновременных соединений

Ожидаются в периоды подключений сервиса, когда будут заводить тесты, и в периоды аттестаций. Основная часть пользователей будет заходить в рабочее время.

Организации среднего бизнеса имеют штат сотрудников от 101 до 250 человек.
Крупный бизнес - это компании с количеством сотрудников более 250.

Предположим следующие предположения по подключениям:

1. В периоды аттестаций ежедневно будут заходить 30% сотрудников. Это от 30 до 75 человек для среднего бизнеса и более 75 человек (допустим, 100) для крупного.
1. Среднее время сессии - 40 мин. 
1. За эти 40 мин люди пройдут 2 - 3 теста.
1. Они не будут непрерывно клацать мышкой, действия в барузере будут происходить довольно редко: запустили тест - подумали - отметили ответ/ы - нажали "Отправить".
1. В период аттестаций менеджеры будут запускать отчёты по своим сотрудникам. Допустим, 3 - 4 раза в день.
1. В период заведения тестов будет заходить 3% сотрудников: это от 1 до 7 менеджеров для среднего бизнеса и от 8 до 15 человек для крупного. 
1. Они будут заводить тесты около 4 ч в день. 

## Описываем возможные угрозы и методы защиты от них

Сервис будет изолированным от внешнего интернета, доступ к нему будет из CRM по ссылке. Критических данных, новостей, движений финансов тут нет, поэтому он не особенно интересен в плане взломов и других противоправных дествий, однако безопасность всё равно является важным фактором. 

Базу данных будем хранить в демилитаризованной зоне.

Обеспечим требования по безопасности к системе БД, не зависящей от данных:
1. Работа в доверенной среде. Доверенная среда — инфраструктура предприятия с её защитными механизмами, обусловленными политикой безопасности.
1. Обеспечение физической безопасности файлов данных. Здесь требования не отличаются от тех, которые применимы к любым другим файлам приложений и пользователей.
1. Организация безопасной и актуальной настройки СУБД.
К данному аспекту относятся такие общие вопросы обеспечения безопасности, как своевременная установка обновлений, отключение неиспользуемых модулей или применение эффективной политики паролей.

Обеспечим требования к целостности информации для систем, зависящим от данных:
1. Безопасность пользовательского программного обеспечения. Речь идёт о задачах построения безопасных механизмов доступа и интерфейсов.
1. Безопасная организация работы с данными. Организация данных и управление ими — ключевой вопрос для системы хранения информации. Сюда входит и задача по организации данных с контролем целостности, и другие задачи, порой специфичные для СУБД. 

Репликацию будем осуществлять с помощью пользователя с правами для репликации.

С данными будем работать также через специально созданных пользователей с реализованной системой прав только к тем объектам, которые необходимы для работы. Выносем средства аутентификации за пределы СУБД в промежуточное программное обеспечение и операционные системы.

Данные будем валидировать на web-сервере с предотвращением SQL-инъекций. 

Выстраивая систему защиты информации и комбинируя различные способы, оптимального эффекта можно добиться последовательно совершая шаги:

1. Выбор защищенного сервера или платформы баз данных, предлагающих собственные системы аудита и мониторинга.
1. Ограничение физического доступа к компьютерам, на которых находятся элементы БД, и ограничение прав доступа пользователей при помощи программных решений.
1. Использование двухслойных решений для организации доступа, при которых пользователь получает допуск к CRM или иной бизнес-системе, содержащим только ссылки на элементы БД. Это минимизирует риск неправомерного использования, изменения или копирования информации.
1. Обеспечить наличие системы резервного копирования и восстановления базы после сбоев.
1. Исключение возможности запуска любых программ или процессов на сервере с БД.

Этот комплекс ограничений снизит риск неправомерного доступа к БД и позволит решить проблему безопасности информации и подтверждения ее достоверности в необходимых случаях.

## Предлагаем стратегии бэкапа, репликации, кластеризации

Для данного типа приложения основная нагрузка - это запросы на чтение данных (OLAP-нагрузка): запросы тестов и отчётов.
Пользователи будут работать со "своими" данными, т.е. создавать и обновлять записи старта своих тестов и записывать ответы на вопросы будут независимо от других пользователей. 
Однако может быть очередь на запись в таблицу ответов на вопросы и обновлений записей в таблице запуска тестов: фиксация количества правильных ответов и времени последнего действия. 
Будет много чтений из таблицы вопросов. 
Будет много вычислений правильности ответов на тесты (там JSONB).

Для данной системы характерна "сезонность" и периодичность нагрузки, приходящейся на дневные часы. В это время система должна быть стабильно доступна для чтения и записи. Важно сохранять данные и поддерживать соединение во время сессии пользователя, чтобы не потерять данные.

Важно настроить систему мониторинга нагрузки на базы данных: использование дисков, количество транзакций, нагрузка на процессов, блокировки в базе данных, длительные транзакции в БД, наличие/отсутствие свободных соединений.

**Бэкапы**

Так как основная нагрузка на базу предполагается в дневные часы, обслуживание базы данных (VACUUM, бэкапирование и восстановление) удобно будет проводить в ночное время. На время бэкапирования сервис может быть остановлен.

Разработаем и утверждим соглашение о качестве сервиса (SLA), где обозначим правила и договорённости, касающиеся бэкапирования.

Для обеспечения сохранения и восстановления данных в случае сбоев реализуем полноценную систему бэкапов: 1) полное резервирование, например, раз в неделю, 2) инкрементное раз в день, 3) дифференциальное раз в час. 

Бэкапы можно снимать со слейвов, т.к. основная нагрузка предполагается на чтение.

Для хранения бэкапов реализуем стратегию «3–2–1». В соответствии с этой концепцией для сохранности данных нужно иметь три копии, которые будут храниться как минимум на двух типах носителей, а одна из копий должна размещаться за пределами организации. Такой способ поможет предотвратить утрату данных в любых ситуациях.

**Репликации и кластеризация**

Настроим масштабирование нагрузки с помощью кластеризации. Используем PgBouncer для управления пулом соединений.

Разработаем и утверждим соглашение о качестве сервиса (SLA), где обозначим правила и договорённости, касающиеся репликации.

Настроим потоковую асинхронную репликацию, чтобы повысить отказоустойчивость и производительность.

Нагрузку по чтению данных, а также отчёты переложим на реплики. Настроим автоматическое переключение серверов в случае отказа мастера. 
